#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var program = require("commander");
var global_1 = require("../lib/core/global");
var bst_statistics_1 = require("../lib/statistics/bst-statistics");
var skillTesting = require("skill-testing-ml");
var skippedOptions = [
    "jest.collectCoverageFrom",
    "jest.moduleFileExtensions",
    "jest.testPathIgnorePatterns",
    "jest.testMatch"
];
program.version(global_1.Global.version());
global_1.Global.initializeCLI(false).then(function () {
    program
        .usage("[test-pattern-regex]")
        .description("Runs unit or end-to-end tests for a skill - automatically searches for YML test files and runs them");
    var optionsFiltered = skillTesting.ConfigurationKeys.filter(function (item) { return skippedOptions.indexOf(item.key) === -1; });
    var regultarOptions = [];
    var jestOptions = [];
    for (var i = 0; i < optionsFiltered.length; i++) {
        if (optionsFiltered[i].key.startsWith("jest")) {
            jestOptions.push(optionsFiltered[i]);
        }
        else {
            regultarOptions.push(optionsFiltered[i]);
        }
    }
    var sortByKey = function (itemA, itemB) {
        if (itemA.key < itemB.key)
            return -1;
        if (itemA.key > itemB.key)
            return 1;
        return 0;
    };
    regultarOptions = regultarOptions.sort(sortByKey);
    jestOptions = jestOptions.sort(sortByKey);
    var options = regultarOptions.concat(jestOptions);
    options.forEach(function (element) {
        program.option("--" + element.key + " <" + element.key + ">", element.text);
    });
    program.parse(process.argv);
    var skillTesterArgs = process.argv.slice(0, 3);
    if (skillTesterArgs.length >= 3) {
        if (skillTesterArgs[2].substring(0, 2) === "--") {
            skillTesterArgs.pop();
        }
    }
    var configurationOverrides = {};
    skillTesting.ConfigurationKeys.forEach(function (element) {
        if (program[element.key]) {
            configurationOverrides[element.key] = program[element.key];
        }
    });
    var testCLI = new skillTesting.CLI();
    testCLI.run(skillTesterArgs, configurationOverrides).then(function (success) {
        var nodeId = undefined;
        if (global_1.Global.config() && global_1.Global.config().secretKey && global_1.Global.config().secretKey()) {
            nodeId = global_1.Global.config().secretKey();
        }
        bst_statistics_1.BstStatistics.instance().record(bst_statistics_1.BstCommand.test, undefined, nodeId, global_1.Global.version());
        process.exitCode = success ? 0 : 1;
    });
});
//# sourceMappingURL=bst-test.js.map